<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daleel Balady Chat</title>
  <style>
    body { font-family: system-ui, Arial; background:#f4f6f8; margin:0; display:flex; height:100vh; }
    .chat { margin:auto; width:420px; max-width:95%; height:80vh; display:flex; flex-direction:column; box-shadow:0 6px 18px rgba(0,0,0,0.08); border-radius:12px; overflow:hidden; background:white;}
    .messages { flex:1; padding:12px; overflow:auto; display:flex; flex-direction:column; gap:8px; }
    .msg.user { align-self:flex-end; background:#007bff;color:white;padding:8px 12px;border-radius:12px 12px 4px 12px; max-width:80%;}
    .msg.ai { align-self:flex-start; background:#eef2ff;color:#111;padding:8px 12px;border-radius:12px 12px 12px 4px; max-width:80%;}
    .input { display:flex; padding:10px; gap:8px; border-top:1px solid #eee; }
    input[type="text"] { flex:1; padding:10px;border-radius:8px;border:1px solid #ddd; }
    button { padding:10px 14px;border-radius:8px;border:none;background:#0b5fff;color:white; cursor:pointer }
    .small { font-size:12px;color:#666 }
  </style>
</head>
<body>
  <div class="chat" role="main" aria-label="Daleel Balady chat">
    <div class="messages" id="messages"></div>
    <div class="input">
      <input id="text" type="text" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ..." />
      <button id="send">Send</button>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const socket = io();

    const messagesEl = document.getElementById("messages");
    const input = document.getElementById("text");
    const sendBtn = document.getElementById("send");


    function addMessage(text, cls = "ai") {
      const d = document.createElement("div");
      d.className = "msg " + cls;
      d.textContent = text;
      messagesEl.appendChild(d);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function addServiceCard(service) {
      const card = document.createElement("div");
      card.style.background = "#fff";
      card.style.border = "1px solid #eee";
      card.style.borderRadius = "10px";
      card.style.padding = "10px";
      card.style.marginBottom = "8px";
      card.style.boxShadow = "0 2px 8px rgba(0,0,0,0.04)";
      card.style.direction = "rtl";
      card.innerHTML = `
        <div style="font-weight:bold;font-size:16px;">${service.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</div>
        <div style="color:#444;margin:6px 0;">${service.description || "Ø¨Ø¯ÙˆÙ† ÙˆØµÙ"}</div>
        <div style="color:#007bff;font-size:14px;">${service.phone && service.phone !== "null" ? `ğŸ“ ${service.phone}` : ""}</div>
      `;
      messagesEl.appendChild(card);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    // Listen for search_results from backend and display as cards
    socket.on("search_results", (results) => {
      if (Array.isArray(results)) {
        results.forEach(addServiceCard);
      }
    });

    sendBtn.onclick = send;
    input.addEventListener("keydown", (e) => { if (e.key === "Enter") send(); });


    function send() {
      const v = input.value.trim();
      if (!v) return;
      addMessage(v, "user");
      // Always send location if available
      const loc = getStoredLocation();
      if (loc && loc.lat && loc.lon) {
        socket.data = socket.data || {};
        socket.data.userLocation = loc;
      }
      socket.emit("user_message", v);
      input.value = "";
    }

    function getStoredLocation() {
      try {
        const locStr = localStorage.getItem("userLocation");
        if (!locStr) return null;
        return JSON.parse(locStr);
      } catch { return null; }
    }

    function storeLocation(coords) {
      try {
        localStorage.setItem("userLocation", JSON.stringify(coords));
      } catch {}
    }

    // server will always send ai_message with JSON string per contract
    socket.on("ai_message", (jsonText) => {
      try {
        const obj = typeof jsonText === "string" ? JSON.parse(jsonText) : jsonText;
        if (obj && obj.function === "reply_to_user" && obj.parameters?.message) {
          addMessage(obj.parameters.message, "ai");
        } else if (obj && obj.function === "query_category") {
          // rare case if server forwards a function object; show a short ack
          addMessage("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«... Ø£Ø±ÙŠÙƒÙ… Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù‚Ø±ÙŠØ¨Ø§Ù‹.", "ai");
        } else {
          // fallback
          addMessage(JSON.stringify(obj), "ai");
        }
      } catch (e) {
        // not JSON? just show raw
        addMessage(String(jsonText), "ai");
      }
    });

    // server requests location -> ask user and get permission

    socket.on("request_location", async (payload) => {
      addMessage("Ø£Ø­ØªØ§Ø¬ Ø¥Ø°Ù†Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù…ÙˆÙ‚Ø¹Ùƒ Ù„ØªÙ‚Ø¯ÙŠÙ… Ù†ØªØ§Ø¦Ø¬ Ø£Ù‚Ø±Ø¨. Ù‡Ù„ ØªØ³Ù…Ø­ØŸ", "ai");
      if (!navigator.geolocation) {
        addMessage("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.", "ai");
        socket.emit("location_response", null);
        return;
      }
      navigator.geolocation.getCurrentPosition((pos) => {
        const coords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        storeLocation(coords);
        socket.emit("location_response", coords);
        addMessage("Ø´ÙƒØ±Ù‹Ø§ â€” Ø³Ø£Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¢Ù†.", "ai");
      }, (err) => {
        addMessage("Ù„Ù… ÙŠØªÙ… Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† Ù„Ù„Ù…ÙˆÙ‚Ø¹.", "ai");
        socket.emit("location_response", null);
      }, { enableHighAccuracy: true, timeout: 10000 });
    });

    // connection state feedback
    socket.on("connect", () => addMessage("Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø£Ù†Ø§ Ø¯Ù„ÙŠÙ„ Ø¨Ù„Ø¯ÙŠ ğŸ¤– â€” Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø£Ùˆ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡.", "ai"));
  </script>
</body>
</html>
